<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Gasbot : ">

    <!--<link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">-->

    <title>Gasbot</title>
    
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="js/d3/d3.js"></script>
    <script type="text/javascript" src="js/crossfilter/crossfilter.js"></script>
    <script type="text/javascript" src="js/dc/dc.js"></script>

    <link href="https://cdn.rawgit.com/novus/nvd3/v1.7.1/build/nv.d3.css" rel="stylesheet" type="text/css">
    <script src="https://cdn.rawgit.com/novus/nvd3/v1.7.1/build/nv.d3.js"></script>

    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        html, body, #chart1, svg {
            margin: 0px;
            padding: 0px;
            height: 100%;
            width: 100%;
        }
    </style>
	
	

  </head>

 <!-- <body>-->
 <body class='with-3d-shadow with-transitions'>
  


    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">

          <h1 id="project_title">Gasbot</h1>
          <h2 id="project_tagline"></h2>


        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
	   </section>




<!-- MAX CODE HERE -->


<div id="chart1"></div>

<script>
    // Wrapping in nv.addGraph allows for '0 timeout render', stores rendered charts in nv.graphs, and may do more in the future... it's NOT required
 var gdataT = [];
 var gdataA = [];
 var gdataL = [];
 var gdataM = [];
    
d3.json("https://data.sparkfun.com/output/9Jjp2qJQ5JuW7vWDZjM5?limit=30", function(error, data) {
  data.forEach(function(d) {
	//console.log("test");
	//console.log(Date.parse(d.timestamp));
	d.timestamp = Date.parse(d.timestamp);
	//d.timestamp = parsetimestamp(d.timestamp);
	//d.timestamp = d3.time.format.parse(d.timestamp);
	//console.log(d.timestamp);
	d.temp = +d.temp;
	d.alch = +d.alcohol;
	d.lpg = +d.lpg;
	d.meth = +d.methane;
	//console.log(d.board);
	if (d.board == "RED"){
	  console.log("using red converion");
	  gdataT.push({x:d.timestamp, y:convertTempRed(+d.temp)});
	}
	else{
	  console.log("using blue conversion");
	  gdataT.push({x:d.timestamp, y:convertTempBlue(+d.temp)});
	}
	gdataA.push({x:d.timestamp, y:+d.alch});
	gdataL.push({x:d.timestamp, y:+d.lpg});
	gdataM.push({x:d.timestamp, y:+d.meth});

  });    
    
    gdataT = gdataT.reverse();
    gdataA = gdataA.reverse();
    gdataL = gdataL.reverse();
    gdataM = gdataM.reverse();
    
 var nvfdata = [
            {
                //area: true,
                values: gdataT,
                key: "Temperature",
                color: "#ff7f0e"
            },
             {
                //area: true,
                values: gdataA,
                key: "Alcohol",
                color: "#2ca02c"
            },
             {
                //area: true,
                values: gdataL,
                key: "LPG",
                color: "#0066FF"
            },
            {
                //area: true,
                values: gdataM,
                key: "Methane",
                color: "#CC33FF"
            }
            
            ];    

    var chart;
    nv.addGraph(function() {
        chart = nv.models.lineChart()
            .options({
                transitionDuration: 300,
                useInteractiveGuideline: true
            })
        ;
        // chart sub-models (ie. xAxis, yAxis, etc) when accessed directly, return themselves, not the parent chart, so need to chain separately
        chart.xAxis
            .axisLabel("Time")
            //.tickFormat(d3.format(',.1f'))
            .tickFormat(function(d) {return d3.time.format('%m-%d-%y %H:%M')(new Date(d))})
            .staggerLabels(true)
        ;
        
        //chart.xScale(d3.time.scale());
        
        chart.yAxis
            .axisLabel('Reading')
            .tickFormat(d3.format(',.2f'))
        ;
        
        //console.log(gdata);
        d3.select('#chart1').append('svg')
            //.datum(sinAndCos())
            .datum(nvfdata)
            .transition().duration(500)
            .call(chart);
        //console.log(gasData());
        nv.utils.windowResize(chart.update);
        return chart;
    });
    
    
    
    
  var x = 2;
  var x1 = (new Date).getTime();
  var run = true;
  //console.log(x1);
  //console.log(nvfdata[0].values);


  setInterval(function(){
  
  ////latest.json
  
	if (!run) return;
	
	
	$.getJSON( "https://data.sparkfun.com/output/9Jjp2qJQ5JuW7vWDZjM5/latest.json", function( json ) {
	
  console.log( Date.parse(json[0].timestamp));
  console.log( "Adding temp: " + String(convertTempRed(+json[0].temp) ));  
  
 //});
	  if (json[0].board == "RED"){
	    nvfdata[0].values.push({
		    //x: (new Date).getTime(),
		    x: Date.parse(json[0].timestamp),
		    //y: Math.random() * 100
		    
		    y: convertTempRed(+json[0].temp)
	    });
	  }
	  else{
	    nvfdata[0].values.push({
		      //x: (new Date).getTime(),
		      x: Date.parse(json[0].timestamp),
		      //y: Math.random() * 100
		      
		      y: convertTempBlue(+json[0].temp)
	      });
	  }
	  
	  nvfdata[1].values.push({
		  //x: (new Date).getTime(),
		  x: Date.parse(json[0].timestamp),
		  //y: Math.random() * 100
		  
		  y: +json[0].alcohol
	  });
	  
	  nvfdata[2].values.push({
		  //x: (new Date).getTime(),
		  x: Date.parse(json[0].timestamp),
		  //y: Math.random() * 100
		  
		  y: +json[0].lpg
	  });
	  
	  nvfdata[3].values.push({
		  //x: (new Date).getTime(),
		  x: Date.parse(json[0].timestamp),
		  //y: Math.random() * 100
		  
		  y: +json[0].methane
	  });
	  
	 
	
	});

	for (var i = 0; i < nvfdata.length; i++){
	
	  if (nvfdata[i].values.length > 30) {
		  nvfdata[i].values.shift();
	  }
	}
	var x1 = (new Date).getTime();
	chart.update();
}, 9000);
    
    
    
    
function convertTempRed(val) {
    //in dec C
    val = (val*(4000/1024)-500)/10;
    
    //in deg F
    val = (val  * 9/5)+32;
    return val;
    }
    
function convertTempBlue(val) {
    //in dec C
    val = (val*(5000/1024)-500)/10;
    
    //in deg F
    val = (val  * 9/5)+32;
    return val;
    }
    
    

});
</script>









    </div>

    <!-- FOOTER  -->
	<!--
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Gasbot maintained by <a href="https://github.com/mmighty">mmighty</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>
	-->

    

  </body>
</html>